---
apiVersion: v1
kind: Namespace
metadata:
  name: nexus-backup
---
# 1. Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-sa
  namespace: nexus-backup
  annotations:
    oci.oraclecloud.com/oci-use-workload-identity: "true"
---
# 2. ClusterRole (Permissão para ler tudo em todos os namespaces)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: backup-read-all
rules:
  # Permissão para listar Namespaces
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]
  # Permissão para ler recursos dentro dos namespaces (para fazer o dump yaml)
  - apiGroups: ["", "apps", "networking.k8s.io", "batch", "extensions"]
    resources: 
      - "pods"
      - "services"
      - "configmaps"
      - "secrets"
      - "persistentvolumeclaims"
      - "deployments"
      - "statefulsets"
      - "ingresses"
      - "jobs"
      - "cronjobs"
    verbs: ["get", "list"]
---
# 3. ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: backup-sa-binding
subjects:
- kind: ServiceAccount
  name: backup-sa
  namespace: nexus-backup
roleRef:
  kind: ClusterRole
  name: backup-read-all
  apiGroup: rbac.authorization.k8s.io
---
# 4. CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: nexus-full-backup
  namespace: nexus-backup
spec:
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600
      template:
        spec:
          serviceAccountName: backup-sa
          containers:
          - name: backup-worker
            image: ghcr.io/synapsehealthtech/nexus-backup:v0.0.2
            imagePullPolicy: Always
            env:
            - name: DB_HOST
              value: "mysql-service"
            - name: DB_USER
              value: "nexus_root_user"
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: mysql-secrets
                  key: root-password
            - name: OCI_BUCKET_NAME
              value: "nexus-backup"
            
            # Ajuste de performance
            - name: MAX_WORKERS
              value: "1"

            #resources:
            #  requests:
            #    memory: "512Mi"
            #    cpu: "500m"
            #  limits:
            #    memory: "2Gi"
            #    cpu: "2000m"

            volumeMounts:
            - name: temp
              mountPath: /tmp
          
          restartPolicy: OnFailure
          volumes:
          - name: temp
            emptyDir: {}
---
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secrets
  namespace: nexus-backup
type: Opaque
data:
  # O valor abaixo deve ser a sua senha codificada em Base64
  # Exemplo: 'minhasenha123' vira 'bWluaYXNlbmhhMTIz'
  root-password: SEByMGxkMCE=